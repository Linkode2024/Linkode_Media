<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>화면 공유 (로컬 테스트)</title>
    <style>
        video {
            width: 100%;
            max-width: 600px;
            border: 2px solid #ccc;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>화면 공유 (로컬 테스트)</h1>
    <button id="startShare">화면 공유 시작</button>
    <video id="localVideo" autoplay muted></video>
    <div id="remoteVideos"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://unpkg.com/mediasoup-client@3.6.30/lib/mediasoup-client.min.js"></script>

    <script>
        // MediasoupClient가 전역 객체로 노출되지 않을 경우를 대비한 폴백
        const MediasoupClient = window.MediasoupClient || window.mediasoupClient;

        // 로컬 테스트를 위해 SockJS 대신 더미 소켓 사용
        const socket = {
            send: (message) => console.log('Sent:', JSON.parse(message)),
            onmessage: null
        };

        let device;
        let transport;
        let producer;

        async function initializeDevice() {
            try {
                device = new MediasoupClient.Device();
                // 로컬 테스트를 위한 더미 RTP Capabilities
                const dummyRtpCapabilities = {
                    codecs: [
                        {
                            kind: 'video',
                            mimeType: 'video/VP8',
                            clockRate: 90000,
                            parameters: {},
                            rtcpFeedback: []
                        }
                    ],
                    headerExtensions: []
                };
                await device.load({ routerRtpCapabilities: dummyRtpCapabilities });
                console.log('Device initialized successfully');
            } catch (error) {
                console.error('Error initializing device:', error);
            }
        }

        async function createTransport() {
            try {
                // 로컬 테스트를 위한 더미 transport 옵션
                const dummyTransportOptions = {
                    id: 'dummy-transport-id',
                    iceParameters: {
                        usernameFragment: 'dummy',
                        password: 'dummy',
                        iceLite: true
                    },
                    iceCandidates: [],
                    dtlsParameters: {
                        role: 'auto',
                        fingerprints: [
                            {
                                algorithm: 'sha-256',
                                value: 'dummy:fingerprint:value'
                            }
                        ]
                    }
                };
                transport = device.createSendTransport(dummyTransportOptions);

                transport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    console.log('Transport connect event', dtlsParameters);
                    callback();
                });

                transport.on('produce', async ({ kind, rtpParameters }, callback, errback) => {
                    console.log('Transport produce event', { kind, rtpParameters });
                    callback({ id: 'dummy-producer-id' });
                });

                console.log('Transport created successfully');
            } catch (error) {
                console.error('Error creating transport:', error);
            }
        }

        async function startScreenShare() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const videoTrack = stream.getVideoTracks()[0];
                producer = await transport.produce({ track: videoTrack });

                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = stream;
                console.log('Screen sharing started successfully');
            } catch (error) {
                console.error('Error starting screen share:', error);
            }
        }

        document.getElementById('startShare').addEventListener('click', async () => {
            try {
                await initializeDevice();
                await createTransport();
                await startScreenShare();
            } catch (error) {
                console.error('Error in screen sharing process:', error);
            }
        });
    </script>
</body>
</html>