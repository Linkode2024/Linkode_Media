<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Room Screen Sharing</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        button { margin-top: 10px; }
        #status { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Study Room Screen Sharing</h1>
    <input type="text" id="roomId" placeholder="Enter Study Room Number">
    <button id="joinRoom">Join Room</button>
    <button id="startScreen" disabled>Start Screen Share</button>
    <button id="stopScreen" disabled>Stop Screen Share</button>
    <div id="status"></div>

    <script>
        let producerTransport;
        let screenProducer;
        let currentRoom;

        const joinRoomBtn = document.getElementById('joinRoom');
        const startScreenBtn = document.getElementById('startScreen');
        const stopScreenBtn = document.getElementById('stopScreen');
        const roomIdInput = document.getElementById('roomId');
        const statusDiv = document.getElementById('status');

        const socket = io('https://localhost:3000', {
            withCredentials: true,
            transports: ['websocket']
        });

        socket.on('connect', () => {
            console.log('Connected to server');
            updateStatus('Connected to server');
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            updateStatus('Connection error: ' + error.message);
        });

        joinRoomBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim();
            if (roomId) {
                currentRoom = roomId;
                socket.emit('join-room', roomId, 'user-' + Math.random().toString(36).substr(2, 9));
                updateStatus('Joining room: ' + roomId);
            } else {
                updateStatus('Please enter a room number');
            }
        });

        socket.on('get-rtp-capabilities', async (routerRtpCapabilities) => {
            updateStatus('Joined room successfully');
            await createProducerTransport();
            startScreenBtn.disabled = false;
        });

        async function createProducerTransport() {
            socket.emit('create-producer-transport', currentRoom, (response) => {
                if (response.error) {
                    updateStatus('Error creating producer transport: ' + response.error);
                    return;
                }
                producerTransport = new RTCPeerConnection(response.params);
                producerTransport.onicecandidate = ({ candidate }) => {
                    if (candidate) {
                        socket.emit('ice-candidate', { candidate });
                    }
                };
                updateStatus('Producer transport created');
            });
        }

        startScreenBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const track = stream.getVideoTracks()[0];
                screenProducer = await producerTransport.addTrack(track, stream);
                socket.emit('produce', currentRoom, 'screen-producer', 'video', screenProducer.getParameters(), (response) => {
                    if (response.error) {
                        updateStatus('Error starting screen share: ' + response.error);
                        return;
                    }
                    socket.emit('start-screen-share', currentRoom, response.id);
                    updateStatus('Screen sharing started');
                    startScreenBtn.disabled = true;
                    stopScreenBtn.disabled = false;
                });

                track.onended = () => {
                    stopScreenShare();
                };
            } catch (error) {
                updateStatus('Error accessing screen: ' + error.message);
            }
        });

        stopScreenBtn.addEventListener('click', stopScreenShare);

        function stopScreenShare() {
            if (screenProducer) {
                socket.emit('stop-screen-share', currentRoom, screenProducer.id);
                screenProducer.track.stop();
                screenProducer = null;
                updateStatus('Screen sharing stopped');
                startScreenBtn.disabled = false;
                stopScreenBtn.disabled = true;
            }
        }

        function updateStatus(message) {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.innerHTML += `<p>${message}</p>`;
            }
            console.log(message);
        }

        socket.on('screen-share-started', ({ producerId }) => {
            updateStatus('Screen share started by another user: ' + producerId);
        });

        socket.on('screen-share-stopped', ({ producerId }) => {
            updateStatus('Screen share stopped by another user: ' + producerId);
        });
    </script>
</body>
</html>