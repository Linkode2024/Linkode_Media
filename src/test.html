<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>화면 공유</title>
    <style>
        video {
            width: 100%;
            max-width: 600px;
            border: 2px solid #ccc;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>화면 공유</h1>
    <button id="startShare">화면 공유 시작</button>
    <video id="localVideo" autoplay muted></video> <!-- 화면 공유 중인 사용자 화면 -->

    <div id="remoteVideos"></div> <!-- 여러 사용자의 화면을 표시할 영역 -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://unpkg.com/mediasoup-client@3.6.30/lib/index.js"></script>
    <script>
        const socket = new SockJS('https://www.linkodemedia.shop/sockjs');
        let device;
        let transport;
        let producer;

        document.getElementById('startShare').addEventListener('click', async () => {
            try {
                // Mediasoup device 초기화
                device = new mediasoupClient.Device();
                
                // 서버에서 RTP Capabilities 가져오기
                socket.send(JSON.stringify({ type: 'getRtpCapabilities' }));
                
                socket.onmessage = async (e) => {
                    const data = JSON.parse(e.data);

                    switch (data.type) {
                        case 'rtpCapabilities':
                            // 서버에서 받은 RTP Capabilities로 device 로드
                            await device.load({ routerRtpCapabilities: data.rtpCapabilities });
                            break;

                        case 'transportCreated':
                            // 서버로부터 받은 transportOptions를 사용해 전송 transport 생성
                            transport = device.createSendTransport(data.transportOptions);

                            // Transport 연결 시도
                            transport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                                try {
                                    // 서버로 DTLS parameters 전송
                                    socket.send(JSON.stringify({ type: 'connectTransport', dtlsParameters }));
                                    callback();
                                } catch (error) {
                                    errback(error);
                                }
                            });

                            // 화면을 공유할 때 Producer 생성
                            transport.on('produce', async ({ kind, rtpParameters }, callback, errback) => {
                                try {
                                    // 서버로 produce 요청 전송
                                    socket.send(JSON.stringify({
                                        type: 'produce',
                                        kind,
                                        rtpParameters
                                    }));

                                    // 서버에서 Producer ID 받기
                                    socket.onmessage = (e) => {
                                        const data = JSON.parse(e.data);
                                        if (data.type === 'produced') {
                                            callback({ id: data.producerId });
                                        }
                                    };
                                } catch (error) {
                                    errback(error);
                                }
                            });

                            // 화면 공유 시작
                            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                            const videoTrack = stream.getVideoTracks()[0];
                            const params = { track: videoTrack };
                            producer = await transport.produce(params);

                            // 공유 중인 화면을 로컬에 렌더링
                            const localVideo = document.getElementById('localVideo');
                            localVideo.srcObject = stream;
                            break;

                        case 'produced':
                            // Producer가 생성되었을 때
                            console.log('Producer created', data.producerId);
                            break;

                        case 'consumed':
                            // 서버에서 consumer 생성 후 데이터 수신
                            const consumer = await transport.consume({
                                id: data.id,
                                producerId: data.producerId,
                                kind: data.kind,
                                rtpParameters: data.rtpParameters
                            });

                            // 다른 사용자의 화면을 표시할 video 요소 생성
                            const remoteStream = new MediaStream();
                            remoteStream.addTrack(consumer.track);
                            const remoteVideo = document.createElement('video');
                            remoteVideo.srcObject = remoteStream;
                            remoteVideo.autoplay = true;
                            document.getElementById('remoteVideos').appendChild(remoteVideo);
                            break;
                    }
                };
            } catch (error) {
                console.error('Error sharing the screen:', error);
            }
        });
    </script>
</body>
</html>
